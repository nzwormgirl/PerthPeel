Create rasters for scenario planning
========================================================

This script imports all of Chris Raymond's social values rasters and the species rasters generated by Maxent for use in the Social Values Zonation Analysis.  A dummy raster of approximately the right extent and a resolution of 500m is created as a base to which all rasters are resampled, using the Hunter region as a mask to remove non-terrestrial areas of habitat.  The social rasters are stacked and multipled by the Hunter region raster to generate a mask to be used to resample the species rasters. All resampled social and species rasters are saved to the directory to be used by the Social Values Zonation analyses.


```{r setup_functions}
#load packages and set working directory
rm(list=ls())
start.time <- proc.time()


  envi.directory <- "~/GIS_data/Perth-Peel/"
  output.directory <- "~/GIS_data/Perth-Peel/environmental data/100m/scenarios/"

setwd(output.directory)

packages(raster)
packages(rgdal)
packages(maptools)
packages(rgeos)

perth <- raster("~/GIS_data/Perth-Peel/environmental data/100m/region.mask.asc")
  perth[!is.na(perth)] <- 0
clipping.mask <- raster("~/GIS_data/Perth-Peel/environmental data/100m/clipping.mask.tif")
  clipping.mask[!is.na(clipping.mask)] <- 0

create.raster <- function (s, mask.raster, label, value, transform=TRUE) {
    
   if(transform==TRUE) {
     proj4string(s) <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
    s <- spTransform(s, CRS("+proj=utm +zone=50 +south +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"))
     }
    
  r <- rasterize(s,mask.raster)
    r[!is.na(r)] <- value
    r <- mask(merge(r,mask.raster),mask.raster, filename=paste0(output.directory,label), format="GTiff", overwrite=T)
    names(r) <- label
    
    plot(r, main=label)
    
   #writeRaster(r,paste0(output.directory,label), format="GTiff", overwrite=T)
    return(r)
  }

```

1.  Create an empty raster the same resolution, extent and projection as the region
2.  Compare existing environmental rasters with the region raster.  If they differ, resample them based on the empty raster and overwrite the original ascii file.
3.  Create an environmental mask by stacking all environmental rasters. Calculate the mean value of all rasters at each pixel and then set to 1, masking out any areas that fall outside the region.  Cells that missing data for any layer will be set to NA.
4. Multiply the stack by the environmental mask to remove all missing cells from all layers and write to new rasters in the Maxent environmental data folder

```{r western swamp tortoise}
epa.bio2 <- readShapePoly(paste0(envi.directory,"EPA/EPA_Biodiversity2_20130322.shp"))
  
wstortoise <- create.raster(epa.bio2[!is.na(epa.bio2$W_Swamp_To),],clipping.mask, label="Pseudemydura_umbrina", value=1, transform=FALSE)

wstortoise.area <- gArea(epa.bio2[!is.na(epa.bio2$W_Swamp_To),],byid=FALSE)/10000
  

```


```{r create_conservation_rasters}
    
# DPAW Regional Parks
  regional.parks16 <- readShapePoly(paste0(envi.directory, "DEC/DEC_RegionalParks_withS16_20110502.shp"))
  regional.parks3.raster <- create.raster(regional.parks16,perth, label="DEC_RegionalParks_withS16_20110502_sect16", value=3)

  regional.parks <- readShapePoly(paste0(envi.directory, "DEC/DEC_RegionalParks_20100901.shp"))
    regional.parks1.raster <- create.raster(regional.parks,perth, label="DEC_RegionalParks_20100901", value=1)

# DPAW Managed Lands & Waters
  managed.lands <- readShapePoly(paste0(envi.directory, "DEC/DEC_ManagedLandsAndWaters_20120601.shp"))
    managed.lands$IUCN[managed.lands$CATEGORY=="State Forest"] <- 6
    
    managed.lands1.raster <- create.raster(managed.lands[is.na(managed.lands$IUCN),],perth, label="DEC_ManagedLandsAndWaters_20120601_No IUCN status", value=1)
    
    managed.lands <- managed.lands[!is.na(managed.lands$IUCN),]
    
    # State Forests (IUCN 6)
    managed.lands2.raster <- create.raster(managed.lands[managed.lands$IUCN=="6",],perth, label="DEC_ManagedLandsAndWaters_20120601_IUCN 6", value=2)
    # IUCN 1-4
    managed.lands3.raster <- create.raster(managed.lands[(managed.lands$IUCN=="1a" | managed.lands$IUCN=="2" | managed.lands$IUCN=="3" | managed.lands$IUCN=="4"),],perth, label="DEC_ManagedLandsAndWaters_20120601_IUCN 1-4", value=3)

# Heritage
world.heritage <- readShapePoly(paste0(envi.directory, "SEWPaC/PP_MNES_extract/PP_WHA_clip.shp"))
  world.heritage.raster <- create.raster(world.heritage,perth, label="PP_WHA_clip", value=1)

national.heritage <- readShapePoly(paste0(envi.directory, "SEWPaC/PP_MNES_extract/PP_NHL_clip.shp"))
  national.heritage.raster <- create.raster(national.heritage,perth, label="PP_NHL_clip", value=1)

commonwealth.heritage <- readShapePoly(paste0(envi.directory, "SEWPaC/PP_MNES_extract/PP_CHL_clip.shp"))
  commonwealth.heritage.raster <- create.raster(commonwealth.heritage,perth, label="PP_CHL_clip", value=1)

# Ramsar
  ramsar <- readShapePoly(paste0(envi.directory, "SEWPaC/PP_MNES_extract/PP_Ramsar_clip.shp"))
  ramsar.raster <- create.raster(ramsar,perth, label="PP_Ramsar_clip", value=1)

epa.bio1 <- readShapePoly(paste0(envi.directory,"EPA/EPA_Biodiversity1_20130322.shp"))
  epa.bio1 <- create.raster(epa.bio1,perth, label="EPA_Biodiversity1_20130322", value=1, transform=FALSE)

epa.bio2 <- readShapePoly(paste0(envi.directory,"EPA/EPA_Biodiversity2_20130322.shp"))
  epa.bio2 <- create.raster(epa.bio2,perth, label="EPA_Biodiversity2_20130322", value=1, transform=FALSE)

epa.bio3 <- readShapePoly(paste0(envi.directory,"EPA/EPA_Biodiversity3_20130322.shp"))
  epa.bio3 <- create.raster(epa.bio3,perth, label="EPA_Biodiversity3_20130322", value=1, transform=FALSE)

# Bush Forever
bushforever.SP28 <- readShapePoly(paste0(envi.directory,"DOP/DoP_StatePlanningPolicy28_BushForeverReserves_20120823.shp"))
  bushforever.SP28.raster <- create.raster(bushforever.SP28,perth, label="DoP_StatePlanningPolicy28_BushForeverReserves_20120823", value=1, transform=FALSE)

```

```{r public amenities}
  
# Drinking Water  
  drinking.water <- readShapePoly(paste0(envi.directory, "DOW/DoW_Public_Drinking_Water_Source_Areas_20130327.shp"))
    drinking.water3 <- drinking.water[drinking.water$PRIORITY=="P1",]
    drinking.water3.raster <- create.raster(drinking.water3,perth, label="DoW_Public_Drinking_Water_Source_Areas_20130327_P1", value=3)

drinking.water2 <- drinking.water[drinking.water$PRIORITY=="P2",]
drinking.water2.raster <- create.raster(drinking.water2,perth, label="DoW_Public_Drinking_Water_Source_Areas_20130327_P2", value=2)

drinking.water1 <- drinking.water[drinking.water$PRIORITY=="P3",]
    drinking.water1.raster <- create.raster(drinking.water1,perth, label="DoW_Public_Drinking_Water_Source_Areas_20130327_P3", value=1)

# Floodways
floodways <- readShapePoly(paste0(envi.directory,"DOW/DoW_FPM_100_Year_ARI_Floodway_and_Flood_Fringe_Areas_20130515.shp"))
  unique(floodways$EXT_TYPE)
  floodways.raster2 <- create.raster(floodways[floodways$EXT_TYPE=="Floodway",],perth, label="DoW_FPM_100_Year_ARI_Floodway_and_Flood_Fringe_Areas_20130515", value=2, transform=FALSE)
floodways.raster3 <- create.raster(floodways[floodways$EXT_TYPE=="Flood Fringe",],perth, label="DoW_FPM_100_Year_ARI_Floodway_and_Flood_Fringe_Areas_20130515", value=2, transform=FALSE)

#MRS
parks.rec <- readShapePoly(paste0(envi.directory,"MRS_PRS/mrspoly_20120928.shp"))
  parks.rec.raster <- create.raster(parks.rec[(parks.rec$DESCRIPTIO=="PARKS & RECREATION" | parks.rec$DESCRIPTIO=="PARKS & RECREATION RESTRICTED"), ],perth, label="mrspoly_20120928", value=1, transform=FALSE)

#PRS
open.space <- readShapePoly(paste0(envi.directory,"MRS_PRS/prspoly_20120928.shp"))
  open.space.raster <- create.raster(open.space[open.space$DESCRIPTIO=="REGIONAL OPEN SPACE" , ],perth, label="prspoly_20120928", value=1, transform=FALSE)

#Ecological Linkages
eco.links <- readShapePoly(paste0(envi.directory,"PBP/PBP_RegionalEcologicalLinkages_20120822.shp"))
  eco.links.raster <- create.raster(eco.links,perth, label="prspoly_20120928", value=1, transform=FALSE)

```

Development Layers

```{r development_scenarios}

SP.activity.node <- readShapePoly(paste0(envi.directory,"DOP/DoP_StructurePlans_ActivityNode_Boundaries_20120903.shp"))
  SP.activity.node.raster <- create.raster(SP.activity.node[open.space$DESCRIPTIO=="REGIONAL OPEN SPACE" , ],perth, label="prspoly_20120928", value=1, transform=FALSE)

SP.district.bound <- readShapePoly(paste0(envi.directory,"DOP/DoP_StructurePlans_District_Boundaries_20120903.shp"))

NE.landuses <- readShapePoly(paste0(envi.directory,"DOP/DoP_StructurePlans_DRAFTNorthEast_LandUses_20120925.shp"))

NE.landuses.raster <- create.raster(NE.landuses[NE.landuses$LU_Zoning!="Conservation" &  NE.landuses$LU_Zoning!="State Forest" & NE.landuses$LU_Zoning!="Public Open Space" & !is.na(NE.landuses$LU_Zoning) & NE.landuses$LU_Zoning!="Rural - conservation/landscape" & NE.landuses$LU_Zoning!="Water", ],perth, label="DoP_StructurePlans_DRAFTNorthEast_LandUses_20120925", value=1, transform=FALSE)

NW.landuses <- readShapePoly(paste0(envi.directory,"DOP/DoP_StructurePlans_DRAFTNorthWest_LandUses_20121217.shp"))
NW.landuses.raster <- create.raster(NW.landuses[NW.landuses$LU_Zoning!="Conservation" & NW.landuses$LU_Zoning!="State forest" & NW.landuses$LU_Zoning!="Public Open Space" & NW.landuses$LU_Zoning!="Water" & NW.landuses$LU_Zoning!="Rural - conservation/landscape" & !is.na(NW.landuses$LU_Zoning), ],perth, label="DoP_StructurePlans_DRAFTNorthWest_LandUses_20121217", value=1, transform=FALSE)

SMP.landuses <- readShapePoly(paste0(envi.directory,"DOP/DoP_StructurePlans_DRAFTSouthMetropolitanPeel_LandUses_20121119.shp"),delete_null_obj=TRUE)
SMP.landuses.raster <- create.raster(SMP.landuses[SMP.landuses$Zones_land!="Conservation" & SMP.landuses$Zones_land!="State Forest" & !is.na(SMP.landuses$Zones_land), ],perth, label="DoP_StructurePlans_DRAFTSouthMetropolitanPeel_LandUses_20121119", value=1, transform=FALSE)

SP.local.bound <- readShapePoly(paste0(envi.directory,"DOP/DoP_StructurePlans_Local_Boundaries_20120903.shp"))

SP.subregional.bound <- readShapePoly(paste0(envi.directory,"DOP/DoP_StructurePlans_SubRegional_Boundaries_20120903.shp"))

SP.subregional.SMP.zones <- readShapePoly(paste0(envi.directory,"DOP/DoP_StructurePlans_SubRegionalSouthMetropolitanPeel_Zonings_20130205.shp"),delete_null_obj=TRUE)

urban.deferred <- readShapePoly(paste0(envi.directory,"DOP/DoP_UndevelopUrbanZonedAreaAndDeferred_20120823.shp"))

urban.expansion <- readShapePoly(paste0(envi.directory,"DOP/DoP_UrbanExpansionInvestigation_20130328.shp"))

urban.front <- readShapePoly(paste0(envi.directory,"DOP/DoP_UrbanFront_20120930.shp"))

brm <- readShapePoly(paste0(envi.directory,"DMP/DMP_BRM_RegionallySignificantBasicRawMaterials_20121106.shp"))

create.raster(brm,value=1,mask.raster=perth,transform=FALSE,label="DMP_BRM_RegionallySignificantBasicRawMaterials_20121106")

mine.leases <- readShapePoly(paste0(envi.directory,"DMP/DMP_BRM_ExtractiveIndustrialLlicences_and_Mining_Tens_20130418_DEC_UFI_clipSAarea.shp"))

urban.land.development <- readShapePoly(paste0(envi.directory,"DOP/DoP_UrbanLandDevelopmentOutlook_2011_20120830.shp"))










```


```{r combine_rasters}
 cons.stack <- stack(regional.parks1.raster,regional.parks3.raster, managed.lands1.raster, managed.lands2.raster, managed.lands3.raster, ramsar.raster, epa.bio1, epa.bio2)

combined.cons <- calc(cons.stack,max)

colours <- rev(terrain.colors(4))
plot(combined.cons, main = "Biodiversity protection", legend=F, col=colours)
  plot(combined.cons, legend.only=T, zlim=c(1,3), col=colours[2:4],axis.args=list(at=seq(1,3,1),labels=c("Low", "Med", "High"), cex.axis=0.6), legend.args=list(text='Conservation priority', side=4, font=2, line=2.5, cex=0.8))

writeRaster(combined.cons,"conservation.scenarios", format="GTiff", overwrite=T)



people.stack <- stack(drinking.water3.raster, drinking.water1.raster, bushforever.SP28.raster,floodways.raster2,floodways.raster3, parks.rec.raster,open.space.raster, world.heritage.raster, national.heritage.raster, commonwealth.heritage.raster)

combined.people <- calc(people.stack,max)

plot(combined.people, main = "Amenity protection", legend=F, col=colours)
  plot(combined.cons, legend.only=T, zlim=c(1,3), col=colours[2:4],axis.args=list(at=seq(1,3,1),labels=c("Low", "Med", "High"), cex.axis=0.6), legend.args=list(text='Conservation priority', side=4, font=2, line=2.5, cex=0.8))

writeRaster(combined.cons,"amenity.scenarios", format="GTiff", overwrite=T)

protected.areas <- calc(stack(combined.cons,combined.people),max)

plot(protected.areas, main = "Protected.areas", legend=F, col=colours)
  plot(protected.areas, legend.only=T, zlim=c(1,3), col=colours[2:4],axis.args=list(at=seq(1,3,1),labels=c("Low", "Med", "High"), cex.axis=0.6), legend.args=list(text='Conservation priority', side=4, font=2, line=2.5, cex=0.8))

writeRaster(protected.areas,"protected.scenarios", format="GTiff", overwrite=T)

structure.plans <- calc(stack(NW.landuses.raster,NE.landuses.raster,SMP.landuses.raster),max)
  

plot(structure.plans, main = "Draft Structure Plans", legend=F, col=colours)
#   plot(structure.plans, legend.only=T, zlim=c(1,3), col=colours[2:4],axis.args=list(at=seq(1,3,1),labels=c("Low", "Med", "High"), cex.axis=0.6), legend.args=list(text='Conservation priority', side=4, font=2, line=2.5, cex=0.8))

writeRaster(structure.plans,"structure.plans.tif", format="GTiff", overwrite=T)

cat("\n","This analysis took",round((proc.time()-start.time)[3]/60,0), "minutes to run with",length(envi.files), "rasters.")

finished("I'm done resampling rasters")
```

Export files for zonation after clipping by vegetation mask

```{r zonation export}

protected.areas <- raster("protected.scenarios.tif")

extant_veg.mask <- raster("~/GIS_data/Perth-Peel/environmental data/100m/extant_veg.mask.tif")

plot(protected.areas.mask <- mask(protected.areas,extant_veg.mask))
writeRaster(protected.areas.mask, "~/GIS_data/Perth-Peel/zonation/100m/protected.areas", format="GTiff", overwrite=T )

structure.plans <- raster("structure.plans.tif")
structure.plans <- reclassify(structure.plans, d(is=c(0,1),becomes=c(1,0)))
plot(structure.plans.mask <- mask(structure.plans,extant_veg.mask))

writeRaster(structure.plans.mask, "~/GIS_data/Perth-Peel/zonation/100m/structure.plans.tif", format="GTiff", overwrite=T )

#BRM
brm <- raster("DMP_BRM_RegionallySignificantBasicRawMaterials_20121106.tif")
brm <- reclassify(brm, d(is=c(0,1),becomes=c(1,0)))
plot(brm.mask <- mask(brm,extant_veg.mask))

writeRaster(brm.mask, "~/GIS_data/Perth-Peel/zonation/100m/brm.mask.tif", format="GTiff", overwrite=T )

# CBC feeding habitat
cbc.food.PB <- raster("~/GIS_data/Perth-Peel/environmental data/100m/vegetation/cbc.feeding.BP.tif")
  plot(cbc.food.PB.mask <- mask(cbc.food.PB,extant_veg.mask))

writeRaster(cbc.food.PB.mask, "~/GIS_data/Perth-Peel/zonation/100m/cbc.feeding.PB.tif", format="GTiff", overwrite=T )

```

*This file was last updated on 17 July 2013 and last run on `r format(Sys.time(), "%d %B %Y")`.*