Resample rasters 
========================================================

This script imports rasters and resamples them so that they all have the same extent.  A region raster of the right extent and a resolution of 500m is used as a base to which all rasters are resampled, using the Hunter region as a mask to remove non-terrestrial areas of habitat.  The environmental rasters are stacked and multipled by the Hunter region raster to generate a mask to be used to resample the species rasters. All resampled environmental and species rasters are saved to the desired output directory to be used for future analyses.


```{r setup_functions}
#load packages and set working directory
rm(list=ls())
start.time <- proc.time()

  envi.directory <- "C:/Users/awhitehead/Documents/GIS_data/Perth-Peel/environmental data/100m/"
  output.directory <- "C:/Users/awhitehead/Documents/GIS_data/Perth-Peel/"

setwd(output.directory)

library(raster)
library(rgdal)

```

1.  Create an empty raster the same resolution, extent and projection as the region
2.  Compare existing environmental rasters with the region raster.  If they differ, resample them based on the empty raster and overwrite the original ascii file.
3.  Create an environmental mask by stacking all environmental rasters. Calculate the mean value of all rasters at each pixel and then set to 1, masking out any areas that fall outside the region.  Cells that missing data for any layer will be set to NA.
4. Multiply the stack by the environmental mask to remove all missing cells from all layers and write to new rasters in the Maxent environmental data folder

```{r convert_rasters}
# raster that shows extent of region
region.mask <- raster(paste0(envi.directory,"region.mask.asc"))

# import environmental rasters
(envi.files <- dir(envi.directory,pattern=".asc$", recursive=T, full.names=F)) 
envi.rasters <- lapply(paste0(envi.directory,"/",envi.files),raster)

# compares extent of environmental raster with region.  If different, resamples and overwrites existing file
for(i in seq(envi.files)){
  r <- envi.rasters[[i]]
  if (extent(r)!=extent(region.mask)) {
    cat("\n","Resampling",names(envi.rasters[[i]]))
    envi.rasters[[i]] <- mask(resample(r,region.mask),region.mask)
      writeRaster(envi.rasters[[i]], paste0(envi.directory,envi.files[i]),overwrite=T)
      } else cat("\n","Extent of",names(r), "matches region")
}

# create a raster stack 
envi.stack <- stack(envi.rasters)
names.envi.stack <- names(envi.stack)

# create a mask that sets missing cells from any layer to zero
envi.mask <- mask(calc(envi.stack,mean),region.mask)
    envi.mask[!is.na(envi.mask)] <- 1

# multiply environmental layers by mask
cropped.envi.stack <- envi.stack*envi.mask
  names(cropped.envi.stack) <- names.envi.stack
cropped.envi.stack <- stack(cropped.envi.stack)

# save environmental layers to output directory as ascii files
for(i in 1:length(names.envi.stack)){
    cat("\n", "Writing ",as.character(names.envi.stack[i]), "to ", getwd())
    writeRaster(cropped.envi.stack[[i]], paste0(output.directory,names.envi.stack[i],".asc"), overwrite=T)
  }

cat("\n","This analysis took",round((proc.time()-start.time)[3]/60,0), "minutes to run with",length(envi.files), "rasters.")

```

*This file was last updated on 08 July 2013 and last run on `r format(Sys.time(), "%d %B %Y")`.*